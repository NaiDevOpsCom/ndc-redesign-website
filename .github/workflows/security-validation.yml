name: Security Validation (Reusable)

on:
  workflow_dispatch:
  workflow_call:
    inputs:
      node-version:
        description: "Node.js version"
        required: false
        default: "20"
        type: string
      check-only:
        description: "Run checks only (no fixes)"
        required: false
        default: false
        type: boolean
      fail-level:
        description: "Minimum vulnerability level to fail on"
        required: false
        type: string
    outputs:
      vulnerabilities:
        description: "Total vulnerability count"
        value: ${{ jobs.security-validation.outputs.vulnerabilities }}
      high:
        description: "High severity count"
        value: ${{ jobs.security-validation.outputs.high }}
      critical:
        description: "Critical severity count"
        value: ${{ jobs.security-validation.outputs.critical }}

permissions:
  contents: read
  pull-requests: read

jobs:
  security-validation:
    name: Security and Dependency Analysis
    runs-on: ubuntu-latest
    timeout-minutes: 15
    outputs:
      vulnerabilities: ${{ steps.dependency-audit.outputs.vulnerabilities }}
      high: ${{ steps.dependency-audit.outputs.high }}
      critical: ${{ steps.dependency-audit.outputs.critical }}

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1 # Shallow for performance

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ inputs.node-version }}
          cache: "npm"

      - name: Validate Lockfile Integrity
        run: |
          echo "üîí Validating lockfile..."

          # Ensure lockfile exists and is valid
          if [ ! -f package-lock.json ]; then
            echo "::error::package-lock.json is required"
            exit 1
          fi

          # Basic JSON validation
          if ! jq empty package-lock.json >/dev/null 2>&1; then
            echo "::error::package-lock.json is not valid JSON"
            exit 1
          fi

          # Check for suspicious URLs
          if grep -q "http://registry.npmjs.org/" package-lock.json; then
            echo "::warning::Found insecure HTTP registry URLs"
          fi

          echo "‚úÖ Lockfile validation passed"

      - name: Install Dependencies
        run: |
          echo "üì¶ Installing dependencies..."
          npm ci --prefer-offline --no-audit --no-fund

      - name: Dependency Security Audit
        id: dependency-audit
        run: |
          echo "üõ°Ô∏è Running security audit..."

          # Run audit with JSON output
          AUDIT_OUTPUT=$(npm audit --audit-level=${{ inputs.fail-level }} --json)
          AUDIT_EXIT_CODE=$?

          # Parse results with jq (install if not present)
          if ! command -v jq &> /dev/null; then
            sudo apt-get update && sudo apt-get install -y jq
          fi

          # Extract vulnerability counts
          HIGH_COUNT=$(echo "$AUDIT_OUTPUT" | jq -r '.metadata.vulnerabilities.high // 0')
          MODERATE_COUNT=$(echo "$AUDIT_OUTPUT" | jq -r '.metadata.vulnerabilities.moderate // 0')
          LOW_COUNT=$(echo "$AUDIT_OUTPUT" | jq -r '.metadata.vulnerabilities.low // 0')
          CRITICAL_COUNT=$(echo "$AUDIT_OUTPUT" | jq -r '.metadata.vulnerabilities.critical // 0')

          # Generate summary
          TOTAL_VULNS=$((HIGH_COUNT + MODERATE_COUNT + LOW_COUNT + CRITICAL_COUNT))

          echo "üìä Security Audit Summary:"
          echo "  Critical: $CRITICAL_COUNT"
          echo "  High: $HIGH_COUNT"
          echo "  Moderate: $MODERATE_COUNT"
          echo "  Low: $LOW_COUNT"
          echo "  Total: $TOTAL_VULNS"

          # Output for GitHub Actions
          echo "vulnerabilities=$TOTAL_VULNS" >> $GITHUB_OUTPUT
          echo "high=$HIGH_COUNT" >> $GITHUB_OUTPUT
          echo "critical=$CRITICAL_COUNT" >> $GITHUB_OUTPUT

          # Fail based on level
          if [ "$AUDIT_EXIT_CODE" -ne 0 ]; then
            echo "::error::Security audit failed at level '${{ inputs.fail-level }}' or higher."
            exit 1
          fi

          echo "‚úÖ Security audit passed at ${{ inputs.fail-level }} level"

      - name: License Compliance Check
        run: |
          echo "üìÑ Checking license compliance..."

          # Check for common problematic licenses
          npm list --depth=0 --json | \
            jq -r '.dependencies | to_entries[] | select(.value.dev == false) | .value | .license | select(. != null and .type != "MIT" and .type != "ISC" and .type != "Apache-2.0")' | \
            while read -r license; do
              echo "::warning::Non-OSI license found: $license"
            done

          echo "‚úÖ License check completed"

      - name: Package Integrity Verification
        run: |
          echo "üîç Verifying package integrity..."

          # Check for suspicious packages
          SUSPICIOUS_PATTERNS="eval script evil system"
          NPM_LS_JSON=$(npm ls --all --json)

          for pattern in $SUSPICIOUS_PATTERNS; do
            MATCHING_PACKAGES=$(echo "$NPM_LS_JSON" | jq -r --arg pattern "$pattern" '[.. | .name? | select(. != null and test($pattern; "i"))] | unique | .[]')
            if [ -n "$MATCHING_PACKAGES" ]; then
              echo "::warning::Found packages matching '$pattern':"
              echo "$MATCHING_PACKAGES"
            fi
          done

          echo "‚úÖ Package integrity verified"
