name: Security Validation (Reusable)

on:
  workflow_dispatch:
  workflow_call:
    inputs:
      node-version:
        description: "Node.js version"
        required: false
        default: "20"
        type: string
      check-only:
        description: "Run checks only (no fixes)"
        required: false
        default: false
        type: boolean
      fail-level:
        description: "Minimum vulnerability level to fail on"
        required: false
        default: "moderate"
        type: string

permissions:
  contents: read
  pull-requests: read

jobs:
  security-validation:
    name: Security and Dependency Analysis
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Need full history for dependency review on PRs

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ inputs.node-version }}
          cache: "npm"

      - name: Validate Lockfile Integrity
        run: |
          echo "ðŸ”’ Validating lockfile with lockfile-lint..."
          # Ensure lockfile exists
          if [ ! -f package-lock.json ]; then
            echo "::error::package-lock.json is required"
            exit 1
          fi
          # Use lockfile-lint for comprehensive validation
          npx lockfile-lint \
            --path package-lock.json \
            --type npm \
            --validate-https \
            --allowed-hosts npm \
            --validate-integrity \
            --validate-package-names
          echo "âœ… Lockfile validation passed"

      - name: Install Dependencies
        run: |
          echo "ðŸ“¦ Installing dependencies..."
          npm ci --prefer-offline --no-audit --no-fund

      - name: Run NPM Audit
        id: npm-audit
        run: |
          echo "ðŸ” Running npm audit..."
          npm audit --audit-level=${{ inputs.fail-level }} --json > audit-results.json || true
          
          # Parse results
          TOTAL=$(jq '.metadata.vulnerabilities | to_entries | map(.value) | add // 0' audit-results.json)
          CRITICAL=$(jq '.metadata.vulnerabilities.critical // 0' audit-results.json)
          HIGH=$(jq '.metadata.vulnerabilities.high // 0' audit-results.json)
          MODERATE=$(jq '.metadata.vulnerabilities.moderate // 0' audit-results.json)
          
          echo "Total vulnerabilities: $TOTAL"
          echo "Critical: $CRITICAL, High: $HIGH, Moderate: $MODERATE"
          
          # Set outputs
          echo "vulnerabilities=$TOTAL" >> $GITHUB_OUTPUT
          echo "critical=$CRITICAL" >> $GITHUB_OUTPUT
          echo "high=$HIGH" >> $GITHUB_OUTPUT
          echo "moderate=$MODERATE" >> $GITHUB_OUTPUT
          
          # Fail based on fail-level
          if [ "${{ inputs.fail-level }}" = "critical" ] && [ "$CRITICAL" -gt 0 ]; then
            echo "::error::Found $CRITICAL critical vulnerabilities"
            exit 1
          elif [ "${{ inputs.fail-level }}" = "high" ] && [ "$((CRITICAL + HIGH))" -gt 0 ]; then
            echo "::error::Found critical/high vulnerabilities"
            exit 1
          elif [ "${{ inputs.fail-level }}" = "moderate" ] && [ "$TOTAL" -gt 0 ]; then
            echo "::error::Found vulnerabilities at moderate or higher"
            exit 1
          fi
          
          echo "âœ… No vulnerabilities found at ${{ inputs.fail-level }} level or above"

      - name: Dependency Review (PR only)
        if: github.event_name == 'pull_request'
        uses: actions/dependency-review-action@v4
        with:
          fail-on-severity: ${{ inputs.fail-level }}
          allow-licenses: MIT, ISC, Apache-2.0, BSD-2-Clause, BSD-3-Clause, Unlicense, CC0-1.0
          comment-summary-in-pr: always
          license-check: true
          vulnerability-check: true

      - name: Upload Audit Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: security-audit-results
          path: audit-results.json
          retention-days: 30