name: Security Validation (Reusable)

on:
  workflow_dispatch:
  workflow_call:
    inputs:
      node-version:
        description: "Node.js version"
        required: false
        default: "20"
        type: string
      check-only:
        description: "Run checks only (no fixes)"
        required: false
        default: false
        type: boolean
      fail-level:
        description: "Minimum vulnerability level to fail on"
        required: false
        default: "moderate"
        type: string

permissions:
  contents: read
  pull-requests: read

jobs:
  security-validation:
    name: Security and Dependency Analysis
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout Repository
        uses: actions/checkout@0c366fd6a839edf440554fa01a7085ccba70ac98 # v4.2.2
        with:
          fetch-depth: 0 # Need full history for dependency review on PRs

      - name: Setup Node.js
        uses: actions/setup-node@60edb5dd545a775178f52524783378180af0d1f8 # v4.2.0
        with:
          node-version: ${{ inputs.node-version }}
          cache: "npm"

      - name: Validate Lockfile Integrity
        run: |
          echo "ðŸ”’ Validating lockfile with lockfile-lint..."
          # Ensure lockfile exists
          if [ ! -f package-lock.json ]; then
            echo "::error::package-lock.json is required"
            exit 1
          fi
          # Use lockfile-lint for comprehensive validation
          npx lockfile-lint \
            --path package-lock.json \
            --type npm \
            --validate-https \
            --allowed-hosts npm \
            --validate-integrity \
            --validate-package-names
          echo "âœ… Lockfile validation passed"

      - name: Install Dependencies
        run: |
          echo "ðŸ“¦ Installing dependencies..."
          npm ci --prefer-offline --no-audit --no-fund --ignore-scripts

      - name: Run NPM Audit
        id: npm-audit
        run: |
          echo "ðŸ” Running npm audit..."

          # Validate fail-level input
          case "${{ inputs.fail-level }}" in
            low|moderate|high|critical) ;;
            *) echo "::error::Invalid fail-level: ${{ inputs.fail-level }} (expected: low|moderate|high|critical)"; exit 2 ;;
          esac

          # First, generate the JSON report for the artifact upload step.
          # The `|| true` ensures this command doesn't fail the step,
          # allowing the artifact to be created even if vulnerabilities are found.
          npm audit --json > audit-results.json || true

          # Verify report exists and is not empty
          if [ ! -s audit-results.json ]; then
            echo "::error::npm audit failed to generate a report. The command may have failed."
            exit 1
          fi

          # Verify report is valid JSON (guard against registry/auth/network errors producing non-JSON output)
          node <<'EOF'
          const fs = require('fs');
          try {
            JSON.parse(fs.readFileSync('audit-results.json', 'utf8'));
          } catch (e) {
            console.error('::error::Failed to parse audit-results.json. This usually indicates a registry or network issue on the runner.');
            console.error(e.message);
            process.exit(1);
          }
          EOF

          # Now, run npm audit again, this time allowing it to fail the step
          # based on its native exit code and the specified audit level.
          # This simplifies the logic by removing manual parsing and failure checks.
          npm audit --audit-level=${{ inputs.fail-level }}

          echo "âœ… No vulnerabilities found at ${{ inputs.fail-level }} level or above"

      - name: Dependency Review (PR only)
        if: github.event.pull_request != null
        uses: actions/dependency-review-action@3c4e3dcb1aa7874d2c16be7d79418e9b7efd6261 # v4.8.2
        with:
          base-ref: ${{ github.event.pull_request.base.sha }}
          head-ref: ${{ github.event.pull_request.head.sha }}
          fail-on-severity: ${{ inputs.fail-level }}
          allow-licenses: MIT, ISC, Apache-2.0, BSD-2-Clause, BSD-3-Clause, Unlicense, CC0-1.0
          comment-summary-in-pr: never
          license-check: true
          vulnerability-check: true

      - name: Upload Audit Results
        if: always()
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
          name: security-audit-results
          path: audit-results.json
          retention-days: 30
          if-no-files-found: warn
