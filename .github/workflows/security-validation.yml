name: Security Validation (Reusable)

on:
  workflow_call:
    inputs:
      node-version:
        description: "Node.js version"
        required: false
        default: "20"
        type: string
      check-only:
        description: "Run checks only (no fixes)"
        required: false
        default: false
        type: boolean
      fail-level:
        description: "Minimum vulnerability level to fail on"
        required: false
        default: "moderate"
        type: string
        options: [low, moderate, high, critical]

permissions:
  contents: read
  pull-requests: read

jobs:
  security-validation:
    name: Security and Dependency Analysis
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1 # Shallow for performance

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ inputs.node-version }}
          cache: "npm"

      - name: Validate Lockfile Integrity
        run: |
          echo "üîí Validating lockfile..."

          # Ensure lockfile exists and is valid
          if [ ! -f package-lock.json ]; then
            echo "::error::package-lock.json is required"
            exit 1
          fi

          # Basic JSON validation
          if ! jq empty package-lock.json >/dev/null 2>&1; then
            echo "::error::package-lock.json is not valid JSON"
            exit 1
          fi

          # Check for suspicious URLs
          if grep -q "http://registry.npmjs.org/" package-lock.json; then
            echo "::warning::Found insecure HTTP registry URLs"
          fi

          echo "‚úÖ Lockfile validation passed"

      - name: Install Dependencies
        run: |
          echo "üì¶ Installing dependencies..."
          npm ci --prefer-offline --no-audit --no-fund

      - name: Dependency Security Audit
        run: |
          echo "üõ°Ô∏è Running security audit..."

          # Run audit with JSON output
          AUDIT_OUTPUT=$(npm audit --audit-level=${{ inputs.fail-level }} --json)
          AUDIT_EXIT_CODE=$?

          # Parse results with jq (install if not present)
          if ! command -v jq &> /dev/null; then
            npm install -g jq
          fi

          # Extract vulnerability counts
          HIGH_COUNT=$(echo "$AUDIT_OUTPUT" | jq -r '.metadata.vulnerabilities.high // 0')
          MODERATE_COUNT=$(echo "$AUDIT_OUTPUT" | jq -r '.metadata.vulnerabilities.moderate // 0')
          LOW_COUNT=$(echo "$AUDIT_OUTPUT" | jq -r '.metadata.vulnerabilities.low // 0')
          CRITICAL_COUNT=$(echo "$AUDIT_OUTPUT" | jq -r '.metadata.vulnerabilities.critical // 0')

          # Generate summary
          TOTAL_VULNS=$((HIGH_COUNT + MODERATE_COUNT + LOW_COUNT + CRITICAL_COUNT))

          echo "üìä Security Audit Summary:"
          echo "  Critical: $CRITICAL_COUNT"
          echo "  High: $HIGH_COUNT"
          echo "  Moderate: $MODERATE_COUNT"
          echo "  Low: $LOW_COUNT"
          echo "  Total: $TOTAL_VULNS"

          # Output for GitHub Actions
          echo "::set-output name=vulnerabilities::$TOTAL_VULNS"
          echo "::set-output name=high::$HIGH_COUNT"
          echo "::set-output name=critical::$CRITICAL_COUNT"

          # Fail based on level
          if [ "$AUDIT_EXIT_CODE" -ne 0 ]; then
            echo "::error::Security audit failed"
            exit 1
          fi

          case "${{ inputs.fail-level }}" in
            "low")
              [ $TOTAL_VULNS -eq 0 ] && exit 0 || exit 1 ;;
            "moderate")
              [ $((HIGH_COUNT + CRITICAL_COUNT)) -eq 0 ] && exit 0 || exit 1 ;;
            "high")
              [ $HIGH_COUNT -eq 0 ] && [ $CRITICAL_COUNT -eq 0 ] && exit 0 || exit 1 ;;
            "critical")
              [ $CRITICAL_COUNT -eq 0 ] && exit 0 || exit 1 ;;
          esac

          echo "‚úÖ Security audit passed at ${{ inputs.fail-level }} level"

      - name: License Compliance Check
        run: |
          echo "üìÑ Checking license compliance..."

          # Check for common problematic licenses
          npm list --depth=0 --json | \
            jq -r '.dependencies | to_entries[] | select(.value.dev == false) | .value | .license | select(. != null and .type != "MIT" and .type != "ISC" and .type != "Apache-2.0")' | \
            while read -r license; do
              echo "::warning::Non-OSI license found: $license"
            done

          echo "‚úÖ License check completed"

      - name: Package Integrity Verification
        run: |
          echo "üîç Verifying package integrity..."

          # Check for suspicious packages
          SUSPICIOUS_PATTERNS="eval script evil system"

          for pattern in $SUSPICIOUS_PATTERNS; do
            COUNT=$(npm ls --depth=0 --json | jq -r '.dependencies | keys | map(select(test($pattern; .))) | length')
            if [ "$COUNT" -gt 0 ]; then
              echo "::warning::Found packages matching '$pattern': $COUNT"
            fi
          done

          echo "‚úÖ Package integrity verified"
