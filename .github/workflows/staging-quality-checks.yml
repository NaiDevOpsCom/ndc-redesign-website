name: Staging Quality Gates

permissions:
  contents: read
  pull-requests: write

# Prevents concurrent runs on the same branch
concurrency:
  group: staging-checks-${{ github.ref }}
  cancel-in-progress: true

on:
  push:
    branches:
      - pre-dev
    paths:
      - "client/src/**"
      - "client/public/**"
      - "package.json"
      - "package-lock.json"
      - "vite.config.ts"
      - "tsconfig.json"
      - ".github/workflows/staging-checks.yml"
  pull_request:
    branches:
      - pre-dev
    paths:
      - "client/src/**"
      - "client/public/**"
      - "package.json"
      - "package-lock.json"
      - "vite.config.ts"
      - "tsconfig.json"
      - ".github/workflows/staging-checks.yml"

jobs:
  quality-checks:
    name: Run Quality Checks
    runs-on: ubuntu-latest

    steps:
      # 1. Check out the code
      - name: Checkout Code
        uses: actions/checkout@0c366fd6a839edf440554fa01a7085ccba70ac98 # v4.2.2

      # 2. Setup Node.js with caching
      - name: Setup Node.js
        uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238 # v6.2.0
        with:
          node-version: 20
          cache: "npm"

      # 3. Install dependencies
      - name: Install Dependencies
        run: npm ci

      # 4. Run Linting
      - name: Run Linting
        run: |
          if npm run lint --if-present; then
            echo "‚úÖ Linting passed"
          else
            echo "‚ùå Linting failed - Please fix linting errors before merging"
            exit 1
          fi

      # 5. Type checking
      - name: Type Check
        run: |
          if npm run type-check --if-present; then
            echo "‚úÖ Type checking passed"
          elif npx tsc --noEmit; then
            echo "‚úÖ Type checking passed"
          else
            echo "‚ùå Type checking failed - Please fix type errors before merging"
            exit 1
          fi

      # 6. Run unit tests
      - name: Run Unit Tests
        run: |
          if npm test --if-present; then
            echo "‚úÖ Tests passed"
          else
            echo "‚ùå Tests failed - Please fix failing tests before merging"
            exit 1
          fi

      # 7. Security audit
      - name: Security Audit
        run: |
          if npm audit --audit-level=moderate; then
            echo "‚úÖ No moderate or higher severity vulnerabilities found"
          else
            echo "‚ùå Security vulnerabilities detected - Please run 'npm audit fix' and address issues"
            exit 1
          fi
        continue-on-error: false

      # 8. Build verification
      - name: Build Verification
        run: |
          echo "Running security generation and build..."
          npm run security:generate
          npm run build

          # Validate build output
          if [ ! -d "dist" ]; then
            echo "‚ùå Build failed - dist/ directory not found"
            exit 1
          fi

          if [ -z "$(ls -A dist)" ]; then
            echo "‚ùå Build failed - dist/ directory is empty"
            exit 1
          fi

          echo "‚úÖ Build successful"

      # 9. Check bundle size
      - name: Check Bundle Size
        run: |
          DIST_SIZE=$(du -sh dist | cut -f1)
          DIST_SIZE_BYTES=$(du -sb dist | cut -f1)

          echo "üì¶ Bundle size: $DIST_SIZE"
          echo "üìä Bundle size (bytes): $DIST_SIZE_BYTES"

          # Optional: Fail if bundle is too large (10MB = 10485760 bytes)
          MAX_SIZE=10485760
          if [ $DIST_SIZE_BYTES -gt $MAX_SIZE ]; then
            echo "‚ö†Ô∏è  Warning: Bundle size exceeds 10MB"
            # Uncomment to enforce size limit:
            # echo "‚ùå Bundle size too large!"
            # exit 1
          else
            echo "‚úÖ Bundle size is acceptable"
          fi

      # 10. Upload build artifact for inspection
      - name: Upload Build Artifact
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        with:
          name: staging-build-${{ github.sha }}
          path: dist
          retention-days: 7

  staging-deployment-verification:
    name: Verify Staging Deployment
    needs: quality-checks
    runs-on: ubuntu-latest
    # Only run on push to staging (after merge), not on PRs
    if: github.event_name == 'push'

    steps:
      # 1. Wait for Vercel deployment
      - name: Wait for Vercel Deployment
        run: |
          echo "‚è≥ Waiting for Vercel to complete deployment..."
          echo "This typically takes 30-60 seconds"
          sleep 45

      # 2. Health check on staging site
      - name: Health Check Staging Site
        run: |
          # Use secret or default staging URL
          STAGING_URL="${{ secrets.STAGING_URL }}"

          if [ -z "$STAGING_URL" ]; then
            echo "‚ö†Ô∏è  STAGING_URL secret not set"
            echo "Please add your Vercel staging URL to GitHub secrets"
            echo "Skipping deployment verification..."
            exit 0
          fi

          echo "üîç Testing: $STAGING_URL"

          # Retry logic for health check
          MAX_RETRIES=5
          RETRY_COUNT=0

          while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
            HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" $STAGING_URL)
            
            if [ "$HTTP_CODE" = "200" ]; then
              echo "‚úÖ Staging site health check passed! Status: $HTTP_CODE"
              break
            else
              RETRY_COUNT=$((RETRY_COUNT + 1))
              if [ $RETRY_COUNT -lt $MAX_RETRIES ]; then
                echo "‚è≥ Attempt $RETRY_COUNT/$MAX_RETRIES failed (Status: $HTTP_CODE), retrying in 10s..."
                sleep 10
              else
                echo "‚ùå Staging site health check failed after $MAX_RETRIES attempts!"
                echo "Last status code: $HTTP_CODE"
                exit 1
              fi
            fi
          done

      # 3. Basic smoke tests
      - name: Run Smoke Tests
        run: |
          STAGING_URL="${{ secrets.STAGING_URL }}"

          if [ -z "$STAGING_URL" ]; then
            echo "Skipping smoke tests (STAGING_URL not configured)"
            exit 0
          fi

          echo "üß™ Running smoke tests..."

          # Test main page
          if curl -f -s $STAGING_URL/ > /dev/null; then
            echo "‚úÖ Main page accessible"
          else
            echo "‚ùå Main page not accessible"
            exit 1
          fi

          # Test if assets are loading (optional)
          if curl -f -s -I $STAGING_URL/assets/ 2>/dev/null | grep -q "200\|403\|404"; then
            echo "‚úÖ Assets path exists"
          else
            echo "‚ö†Ô∏è  Assets path check inconclusive (may be normal)"
          fi

          # Check for critical errors in HTML
          PAGE_CONTENT=$(curl -s $STAGING_URL/)
          if echo "$PAGE_CONTENT" | grep -qi "error\|exception\|failed to compile"; then
            echo "‚ö†Ô∏è  Warning: Potential errors detected in page content"
          else
            echo "‚úÖ No obvious errors in page content"
          fi

          echo "‚úÖ All smoke tests passed!"

      # 4. Performance check (optional)
      - name: Basic Performance Check
        run: |
          STAGING_URL="${{ secrets.STAGING_URL }}"

          if [ -z "$STAGING_URL" ]; then
            echo "Skipping performance check"
            exit 0
          fi

          echo "‚ö° Checking response time..."

          RESPONSE_TIME=$(curl -o /dev/null -s -w '%{time_total}\n' $STAGING_URL)

          echo "Response time: ${RESPONSE_TIME}s"

          # Optional: Fail if response time is too slow (e.g., > 5 seconds)
          if (( $(echo "$RESPONSE_TIME > 5.0" | bc -l) )); then
            echo "‚ö†Ô∏è  Warning: Response time is slow (>${RESPONSE_TIME}s)"
            # Uncomment to enforce performance requirement:
            # exit 1
          else
            echo "‚úÖ Response time is acceptable"
          fi

  status-report:
    name: Report Status
    needs: [quality-checks, staging-deployment-verification]
    runs-on: ubuntu-latest
    if: always()

    steps:
      - name: Check Results
        run: |
          echo "üìä Staging Checks Summary"
          echo "=========================="

          if [ "${{ needs.quality-checks.result }}" = "success" ]; then
            echo "‚úÖ Quality checks: PASSED"
          else
            echo "‚ùå Quality checks: FAILED"
          fi

          if [ "${{ needs.staging-deployment-verification.result }}" = "success" ] || [ "${{ needs.staging-deployment-verification.result }}" = "skipped" ]; then
            echo "‚úÖ Deployment verification: PASSED"
          else
            echo "‚ùå Deployment verification: FAILED"
          fi

          if [ "${{ needs.quality-checks.result }}" = "success" ] && ([ "${{ needs.staging-deployment-verification.result }}" = "success" ] || [ "${{ needs.staging-deployment-verification.result }}" = "skipped" ]); then
            echo ""
            echo "üéâ All staging checks passed! Ready for production."
            exit 0
          else
            echo ""
            echo "‚ö†Ô∏è  Some checks failed. Please review the errors above."
            exit 1
          fi
