# This workflow verifies the integrity and security of the build artifacts.
# It ensures that:
# 1. The application builds successfully (including TypeScript validation via the build script).
# 2. No source maps are generated (preventing source code leakage).
# 3. No console.log or debugger statements remain in the production build.

name: Hardened Build Verification

permissions:
  contents: read
  pull-requests: read

# Optimized concurrency - branch-based with global limit
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

# Global environment variables for all jobs
env:
  NODE_VERSION: "20"
  CACHE_VERSION: "v1"

on:
  push:
    branches:
      - main
      - pre-staging
  pull_request:
    branches:
      - main
      - pre-staging

jobs:
  security-scan:
    name: Security Scan
    uses: ./.github/workflows/security-validation.yml
    with:
      node-version: "20"
      fail-level: "moderate"
    secrets: inherit

  verify-hardening:
    name: Verify Hardening
    needs: security-scan
    runs-on: ubuntu-latest
    timeout-minutes: 15
    permissions:
      contents: read
    steps:
      - name: Checkout repository
        uses: actions/checkout@0c366fd6a839edf440554fa01a7085ccba70ac98 # v4.2.2

      - name: Setup Node.js
        uses: ./.github/actions/cache-vite-npm
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install and Validate Dependencies
        run: |
          echo "ðŸ“¦ Installing dependencies with lockfile validation..."
          npm ci

          echo "ðŸ”’ Validating lockfile integrity..."
          npx lockfile-lint \
            --path package-lock.json \
            --type npm \
            --validate-https \
            --allowed-hosts npm \
            --validate-integrity \
            --validate-package-names

          echo "âœ… Dependencies installed and validated successfully"

      - name: Build Hardened App (Typecheck + Build)
        run: npm run build -- --mode production
        env:
          GITHUB_REF_NAME: ${{ github.ref_name }}

      - name: Cache Vitest
        uses: actions/cache@v4
        with:
          path: .vitest-cache
          key: vitest-${{ runner.os }}-${{ env.NODE_VERSION }}-${{ hashFiles('package-lock.json', 'client/src/utils/__tests__/hardenedBuildCheck.test.ts') }}
          restore-keys: |
            vitest-${{ runner.os }}-${{ env.NODE_VERSION }}-

      - name: Hardened Build Unit Test (CI enforcement)
        run: npx vitest run client/src/utils/__tests__/hardenedBuildCheck.test.ts --root client --cache --cacheDir .vitest-cache

      - name: Verify No Source Maps
        run: |
          if find dist -name "*.map" | grep -q .; then
            echo "::error::Source maps found in hardened build! Hardening failed."
            exit 1
          else
            echo "SUCCESS: No source maps found."
          fi

      - name: Verify No Console/Debugger Statements
        run: |
          # Search for any `console.*` usage or `debugger` in the minified js files.
          # Exclude third-party analytics files which may contain console statements.
          if find dist -name "*.js" ! -name "analytics.js" -print0 | xargs -0 grep -lE "console\.|debugger"; then
            echo "::error::Found console or debugger statements in hardened build! Hardening failed."
            exit 1
          else
            echo "SUCCESS: No console or debugger statements found."
          fi
