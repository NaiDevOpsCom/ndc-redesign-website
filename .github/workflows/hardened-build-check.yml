# This workflow verifies the integrity and security of the build artifacts.
# It ensures that:
# 1. The application builds successfully (including TypeScript validation via the build script).
# 2. No source maps are generated (preventing source code leakage).
# 3. No console.log or debugger statements remain in the production build.

name: Hardened Build Verification

on:
  push:
    branches:
      - main
      - pre-dev
  pull_request:
    branches:
      - main
      - pre-dev

jobs:
  verify-hardening:
    name: Verify Hardening
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Install dependencies (lockfile integrity)
        run: npm ci

      - name: Lint lockfile (registry/https)
        run: npx lockfile-lint --path package-lock.json --type npm --validate-https --allowed-hosts npm

      - name: Scan dependencies
        uses: actions/dependency-review-action@v4

      - name: Build Hardened App (Typecheck + Build)
        run: npm run build
        env:
          GITHUB_REF_NAME: ${{ github.ref_name }}

      - name: Verify No Source Maps
        run: |
          if find dist -name "*.map" | grep -q .; then
            echo "::error::Source maps found in hardened build! Hardening failed."
            exit 1
          else
            echo "SUCCESS: No source maps found."
          fi

      - name: Verify No Console/Debugger Statements
        run: |
          # Search for any `console.*` usage or `debugger` in the minified js files.
          # This is more robust than just checking for `console.log`.
          if find dist -name "*.js" -print0 | xargs -0 grep -lE "console\.|debugger"; then
            echo "::error::Found console or debugger statements in hardened build! Hardening failed."
            exit 1
          else
            echo "SUCCESS: No console or debugger statements found."
          fi
