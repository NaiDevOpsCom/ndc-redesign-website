name: Handle Vercel Deployments

on:
  deployment_status:
    types: [success, failure, error]

permissions:
  contents: read
  deployments: write

concurrency:
  group: ${{ github.workflow }}-${{ github.event.deployment.ref }}
  cancel-in-progress: false

jobs:
  update-github-deployment:
    if: github.event.deployment.payload.type == 'vercel'
    runs-on: ubuntu-latest
    steps:
      - name: Create or Update Managed Deployment
        uses: actions/github-script@v7
        with:
          script: |
            const { state, target_url } = context.payload.deployment_status;
            const { environment, ref } = context.payload.deployment;

            // Map Vercel environments/branches to our managed GitHub environments
            let managedEnv = environment;
            if (environment.includes('preview')) {
              managedEnv = 'preview';
            } else if (ref === 'pre-staging' || environment === 'staging') {
              managedEnv = 'staging';
            } else if (environment === 'production') {
              if (ref === 'main') {
                managedEnv = 'production';
              } else {
                managedEnv = `${environment}-${ref}`;
                core.warning(`Unexpected production deployment triggered from non-main branch: ${ref}. Mapping to: ${managedEnv}`);
              }
            }

            try {
              // Create a formal GitHub deployment for our tracked environment
              const deployment = await github.rest.repos.createDeployment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                ref: ref,
                environment: managedEnv,
                description: `${managedEnv} deployment via Vercel`,
                auto_merge: false,
                required_contexts: []
              });

              // Handle cases where deployment might not return an ID immediately (e.g., 202 Accepted, 409 Conflict)
              if (!deployment.data || !deployment.data.id) {
                const msg = `Deployment requested but no ID returned (Status: ${deployment.status}). Context: ref=${ref}, managedEnv=${managedEnv}`;
                if (deployment.status === 202) {
                  console.log(`${msg} - Deployment is queued.`);
                  return;
                } else {
                  throw new Error(msg);
                }
              }

              await github.rest.repos.createDeploymentStatus({
                owner: context.repo.owner,
                repo: context.repo.repo,
                deployment_id: deployment.data.id,
                state: state,
                environment_url: target_url,
                log_url: `https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`,
                description: `Managed ${managedEnv} deployment ${state}`
              });
              
              console.log(`Successfully acknowledged ${managedEnv} deployment with status ${state}`);
            } catch (error) {
              core.setFailed(`Failed to manage deployment status: ${error.message}`);
            }
